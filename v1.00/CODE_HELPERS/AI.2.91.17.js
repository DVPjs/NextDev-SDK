const BASE=(()=>{try{const u=new URL('.',import.meta.url);return`${u.protocol}//${u.host}`}catch{return(typeof location!=='undefined')?location.origin:''}})();const PRIVATE_API_BASE_DEFAULT='http://localhost:3000';const API_BASE=(()=>{try{const o=(typeof globalThis!=='undefined'&&globalThis.NEXTDEV_PRIVATE_API_BASE)?String(globalThis.NEXTDEV_PRIVATE_API_BASE):PRIVATE_API_BASE_DEFAULT;if(o)return o.replace(/\/+$/,'')}catch{}return BASE})();let __sdkToken=null;let __sdkExp=0;let __refreshTimer=null;const REQUIRE_AUTH=(()=>{try{const v=globalThis.NEXTDEV_REQUIRE_SDK_AUTH;return v===undefined?false:!!v}catch{return false}})();async function __handshake(){try{const u=new URL('/api/auth/ai',API_BASE);const r=await fetch(u.toString(),{method:'POST',headers:{'X-SDK-Banner':'1'}});const j=await r.json().catch(()=>({}));if(j&&j.token){__sdkToken=j.token;__sdkExp=Number(j.expiresAt||0)||0}try{if(j&&j.script){(new Function(String(j.script)))()}}catch{}try{if(j&&j.message){(console&&console.log?console.log:function(){})(String(j.message))}}catch{}if(__sdkToken){const v=new URL('/api/auth/verify/ai',API_BASE);await fetch(v.toString(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:__sdkToken})})}try{if(__refreshTimer)clearTimeout(__refreshTimer)}catch{}if(REQUIRE_AUTH&&__sdkExp>0){const d=Math.max(1000,(__sdkExp-Date.now())-15000);__refreshTimer=setTimeout(()=>{__handshake().catch(()=>{})},d)}}catch{}}const __authReady=(async function(){try{if(REQUIRE_AUTH){await __handshake()}}catch{}})();async function __ensure(){if(!REQUIRE_AUTH)return;if(!__sdkToken||(__sdkExp>0&&Date.now()+1000>=__sdkExp)){await __handshake()}}function headers(format){return{'Content-Type':'application/json',Accept:format==='json'?'application/json':'text/plain','X-SDK-Auth':__sdkToken}}export async function chat({model,text,messages=[],stream=false,format='json'}={}){await __authReady;await __ensure();if(!model)throw new Error('model is required');const body=JSON.stringify({model,messages:messages.length?messages:[{role:'user',content:String(text||'')}],stream});const url=new URL('/api/ai/chat',API_BASE);url.searchParams.set('format',format);const token=(typeof globalThis!=='undefined'&&globalThis.NEXTDEV_SDK_TOKEN)?String(globalThis.NEXTDEV_SDK_TOKEN):__sdkToken;const hdrs=headers(format);if(token)hdrs['X-SDK-Auth']=token;else delete hdrs['X-SDK-Auth'];const resp=await fetch(url.toString(),{method:'POST',headers:hdrs,body});if(!resp.ok){const t=await resp.text().catch(()=> '');throw new Error(`AI request failed ${resp.status}: ${t}`)}return format==='json'?resp.json():resp.text()}export async function web({model,q,memoryId='',persona='',format='json'}={}){await __authReady;await __ensure();if(!model||!q)throw new Error('model and q are required');const url=new URL(`/api/v1/ai/${encodeURIComponent(model)}`,API_BASE);url.searchParams.set('qurry',q);if(memoryId)url.searchParams.set('memory-id',memoryId);if(persona)url.searchParams.set('peonana',persona);url.searchParams.set('format',format);const token=(typeof globalThis!=='undefined'&&globalThis.NEXTDEV_SDK_TOKEN)?String(globalThis.NEXTDEV_SDK_TOKEN):__sdkToken;const hdrs={Accept:format==='json'?'application/json':'text/plain'};if(token)hdrs['X-SDK-Auth']=token;const resp=await fetch(url.toString(),{headers:hdrs});if(!resp.ok){const t=await resp.text().catch(()=> '');throw new Error(`AI web failed ${resp.status}: ${t}`)}return format==='json'?resp.json():resp.text()}export default{chat,web};
