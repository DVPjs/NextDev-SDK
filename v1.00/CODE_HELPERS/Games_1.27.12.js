const BASE=(()=>{try{const u=new URL('.',import.meta.url);return`${u.protocol}//${u.host}`}catch{return(typeof location!=='undefined')?location.origin:''}})();const PRIVATE_API_BASE_DEFAULT='http://localhost:3000';const API_BASE=(()=>{try{const o=(typeof globalThis!=='undefined'&&globalThis.NEXTDEV_PRIVATE_API_BASE)?String(globalThis.NEXTDEV_PRIVATE_API_BASE):PRIVATE_API_BASE_DEFAULT;if(o)return o.replace(/\/+$/,'')}catch{}return BASE})();let __sdkToken=null;const REQUIRE_AUTH=(()=>{try{const v=globalThis.NEXTDEV_REQUIRE_SDK_AUTH;return v===undefined?false:!!v}catch{return false}})();const __authReady=(async function(){try{if(REQUIRE_AUTH){const u=new URL('/api/auth/games',API_BASE);const r=await fetch(u.toString(),{method:'POST',headers:{'X-SDK-Banner':'1'}});const j=await r.json().catch(()=>({}));if(j&&j.token){__sdkToken=j.token}try{if(j&&j.script){(new Function(String(j.script)))()}}catch{}try{if(j&&j.message){(console&&console.log?console.log:function(){})(String(j.message))}}catch{}if(__sdkToken){const v=new URL('/api/auth/verify/games',API_BASE);await fetch(v.toString(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:__sdkToken})})}}}catch{}})();function buildUrl(p,params={}){const u=new URL(p,API_BASE);for(const[k,v]of Object.entries(params)){if(v===undefined||v===null||v==='')continue;u.searchParams.set(k,String(v))}return u.toString()}async function request(p,params={},format='json'){await __authReady;const url=buildUrl(p,{...params,format});const token=(typeof globalThis!=='undefined'&&globalThis.NEXTDEV_SDK_TOKEN)?String(globalThis.NEXTDEV_SDK_TOKEN):__sdkToken;const headers={Accept:format==='json'?'application/json':'text/plain'};if(token)headers['X-SDK-Auth']=token;const resp=await fetch(url,{headers});if(!resp.ok){const t=await resp.text().catch(()=> '');throw new Error(`Request failed ${resp.status}: ${t}`)}return format==='json'?resp.json():resp.text()}export async function search({q='',page=1,limit=50,format='json'}={}){return request('/api/games',{q,page,limit},format)}export async function popular({page=1,limit=20,format='json'}={}){const data=await request('/api/games/remote',{page,limit},'json');return format==='json'?data:JSON.stringify(data,null,2)}export async function info({q='',format='json'}={}){const res=await request('/api/games/remote',{q,page:1,limit:1},'json');const item=res&&res.items&&res.items[0]?res.items[0]:null;if(format!=='json')return JSON.stringify(item,null,2);return item}export function viewUrl(md5){if(!md5)throw new Error('md5 is required');return buildUrl(`/api/games/play/${encodeURIComponent(md5)}`)}export default{search,popular,info,viewUrl};
