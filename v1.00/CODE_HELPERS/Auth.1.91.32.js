const BASE=(()=>{try{const t=new URL(".",import.meta.url);return`${t.protocol}//${t.host}`}catch{return"undefined"!=typeof location?location.origin:""}})(),API_BASE=BASE;function getUserToken(){try{if(globalThis.NEXTDEV_USER_TOKEN)return String(globalThis.NEXTDEV_USER_TOKEN)}catch{}try{if(globalThis.localStorage){const t=globalThis.localStorage.getItem("nextdev_user_token");if(t)return String(t)}}catch{}return""}function setUserToken(t){try{globalThis.NEXTDEV_USER_TOKEN=String(t||"")}catch{}try{globalThis.localStorage&&globalThis.localStorage.setItem("nextdev_user_token",String(t||""))}catch{}}function getTenantToken(){try{if(globalThis.NEXTDEV_TENANT_TOKEN)return String(globalThis.NEXTDEV_TENANT_TOKEN)}catch{}try{if(globalThis.localStorage){const t=globalThis.localStorage.getItem("nextdev_tenant_token");if(t)return String(t)}}catch{}return""}function setTenantToken(t){try{globalThis.NEXTDEV_TENANT_TOKEN=String(t||"")}catch{}try{globalThis.localStorage&&globalThis.localStorage.setItem("nextdev_tenant_token",String(t||""))}catch{}}function headers(t=!0){const e={Accept:"application/json","Content-Type":"application/json","X-SDK-Banner":"1"};try{const n=globalThis&&globalThis.NEXTDEV_SDK_TOKEN||"";t&&n&&(e["X-SDK-Auth"]=n)}catch{}const n=getUserToken();n&&(e["X-Auth-Token"]=n,e.Authorization="Bearer "+n);try{const t="undefined"!=typeof location&&location.origin?location.origin:"";t&&(e["X-Auth-Domain"]=t)}catch{}const o=getTenantToken();return o&&(e["X-Custom-Auth"]=o,e["X-Custom-Auth-Token"]=o),e}async function post(t,e,n=!0){const o=await fetch(`${API_BASE}${t}`,{method:"POST",headers:headers(n),body:JSON.stringify(e||{})}),r=await o.text();try{const t=JSON.parse(r);return{ok:o.ok,status:o.status,json:t,text:r}}catch{return{ok:o.ok,status:o.status,json:null,text:r}}}async function get(t,e,n=!0){const o=new URL(`${API_BASE}${t}`);for(const[t,n]of Object.entries(e||{}))null!=n&&""!==n&&o.searchParams.set(t,String(n));const r=await fetch(o.toString(),{headers:headers(n)}),a=await r.text();try{const t=JSON.parse(a);return{ok:r.ok,status:r.status,json:t,text:a}}catch{return{ok:r.ok,status:r.status,json:null,text:a}}}function extractField(t,e){for(const n of e){const e=t.querySelector(n);if(e)return String(e.value||"").trim()}return""}function checkBranding(t){const e="Powered by nextdev";try{String(t.textContent||"").toLowerCase().includes(e.toLowerCase())||console.warn(`[NextDev Auth SDK] branding missing; please include "${e}" in your form.`)}catch{}}export async function config(){return get("/api/user-auth/config",{},!1)}export async function signup({email:t,username:e,password:n}){return post("/api/user-auth/signup",{email:t,username:e,password:n},!1)}export async function login({email:t,username:e,password:n,id:o}){return post("/api/user-auth/login",{email:t,username:e,password:n,id:o},!1)}export async function issueDomainToken(){const t=await post("/api/user-auth/issue-domain-token",{},!1);if(t&&t.ok&&t.json&&t.json.token)try{setTenantToken(t.json.token)}catch{}return t}export async function verifyEmail({email:t,code:e}){return post("/api/user-auth/verify-email",{email:t,code:e},!1)}export async function me(){return get("/api/user-auth/me",{},!1)}export async function guard(t){return get("/api/user-auth/guard",{path:t},!1)}export function attachFormHandlers({loginSelector:t=".nd-login-form",signupSelector:e=".nd-signup-form"}={},n={}){try{const o=document.querySelector(t)||null,r=document.querySelector(e)||null;o&&(checkBranding(o),o.addEventListener("submit",(async t=>{try{t.preventDefault();const e=extractField(o,[".nd-email",'[name="email"]']),r=extractField(o,[".nd-username",'[name="username"]']),a=extractField(o,[".nd-password",'[name="password"]']),s=await login({email:e,username:r,password:a});s.ok&&s.json&&s.json.token?(setUserToken(s.json.token),n.onLoginSuccess&&n.onLoginSuccess(s.json)):n.onLoginError&&n.onLoginError(s.json||s.text)}catch(t){n.onLoginError&&n.onLoginError({error:"login_failed",detail:String(t&&t.message||t)})}}))),r&&(checkBranding(r),r.addEventListener("submit",(async t=>{try{t.preventDefault();const e=extractField(r,[".nd-email",'[name="email"]']),o=extractField(r,[".nd-username",'[name="username"]']),a=extractField(r,[".nd-password",'[name="password"]']),s=await signup({email:e,username:o,password:a});s.ok&&s.json?(s.json.token&&setUserToken(s.json.token),n.onSignupSuccess&&n.onSignupSuccess(s.json)):n.onSignupError&&n.onSignupError(s.json||s.text)}catch(t){n.onSignupError&&n.onSignupError({error:"signup_failed",detail:String(t&&t.message||t)})}})))}catch(t){console.error("[NextDev Auth SDK] attachFormHandlers failed",t&&t.stack||t)}}export default{config:config,signup:signup,login:login,verifyEmail:verifyEmail,me:me,guard:guard,attachFormHandlers:attachFormHandlers,setUserToken:setUserToken,getUserToken:getUserToken,issueDomainToken:issueDomainToken};export const setTenant=setTenantToken;
